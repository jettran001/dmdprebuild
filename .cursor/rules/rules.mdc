---
description: 
globs: 
alwaysApply: true
---
# LUáº¬T Tá»I CAO: Má»ŒI HÃ€NH Äá»˜NG PHáº¢I TUÃ‚N THá»¦ 100% QUY Táº®C TRONG FILE NÃ€Y.
# Cáº¤M Bá» QUA, Cáº¤M GIáº¢I THÃCH, Cáº¤M Sá»¬A NGOÃ€I LUá»’NG, Cáº¤M Tá»° Ã.
# Náº¾U VI PHáº M, PHáº¢I LIá»†T KÃŠ Láº I TOÃ€N Bá»˜ THAO TÃC ÄÃƒ LÃ€M.
- Báº¯t buá»™c tuÃ¢n thá»§ vÃ  thá»±c hiá»‡n Ä‘Ãºng má»‡nh lá»‡nh Ä‘Æ°á»£c giao, khÃ´ng tá»± Ã½ thay Ä‘á»•i má»‡nh lá»‡nh . 
- Báº¯t buá»™c Ä‘á»c file .cursorrc trÆ°á»›c khi táº¡o code vÃ  sá»­a lá»—i .
- Báº¯t buá»™c tuÃ¢n thá»§ nghiÃªm ngáº·t quy táº¯c trong .cursorrc .
- Cáº¤M KHÃ”NG ÄÆ¯á»¢C Táº O FILE Má»šI KHI TAO CHÆ¯A Äá»’NG Ã 
- Báº¯t buá»™c kiá»ƒm tra Ä‘áº§u tiÃªn file manifest táº¡i thÆ° má»¥c domain khi Ä‘Æ°á»£c yÃªu cáº§u quÃ©t cáº¥u trÃºc.  
- KHÃ”NG tá»± Ã½ táº¡o file chá»‰ Ä‘á»ƒ láº¥p lá»—i mod, chá»‰ táº¡o file khi thá»±c sá»± cáº§n thiáº¿t cho code thá»±c thi vÃ  Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n rÃµ rÃ ng.
- KHÃ”NG dÃ¹ng manifest Ä‘á»ƒ quyáº¿t Ä‘á»‹nh táº¡o file/module, chá»‰ dÃ¹ng manifest nhÆ° tÃ i liá»‡u tham kháº£o tá»• chá»©c code.
- Náº¿u module khÃ´ng cÃ²n dÃ¹ng, pháº£i xÃ³a khai bÃ¡o mod khá»i code, khÃ´ng táº¡o file rá»—ng.
- Chá»‰ sá»­a code thá»±c táº¿, khÃ´ng sá»­a ngoÃ i pháº¡m vi Ä‘Æ°á»£c phÃ©p, khÃ´ng láº·p láº¡i trait/service á»Ÿ nhiá»u nÆ¡i.
- Náº¿u vi pháº¡m, pháº£i liá»‡t kÃª láº¡i toÃ n bá»™ thao tÃ¡c Ä‘Ã£ lÃ m khi Ä‘Æ°á»£c yÃªu cáº§u.


# .cursorrc - Quy táº¯c phÃ¡t triá»ƒn dá»± Ã¡n Diamondchain (chuyá»ƒn tá»« .cursorrc)

     # LUáº¬T Tá»I CAO: Má»ŒI HÃ€NH Äá»˜NG PHáº¢I TUÃ‚N THá»¦ 100% QUY Táº®C TRONG FILE NÃ€Y.
     # Cáº¤M Bá» QUA, Cáº¤M GIáº¢I THÃCH, Cáº¤M Sá»¬A NGOÃ€I LUá»’NG, Cáº¤M Tá»° Ã.
     # Náº¾U VI PHáº M, PHáº¢I LIá»†T KÃŠ Láº I TOÃ€N Bá»˜ THAO TÃC ÄÃƒ LÃ€M.

# === DEPENDENCY POLICY (Báº®T BUá»˜C CHO TOÃ€N Dá»° ÃN) ===
dependency_policy:
  libp2p:
    version: "0.35.1"
    features: ["tcp", "dns", "async-std", "noise", "mplex", "yamux", "websocket", "kad", "mdns"]
  ipfs-embed: "0.17.0"
  bip39: "2.1.0"
  bip32: "0.5"
  uuid:
    version: "1.3.0"
    features: ["v4", "serde"]
  tokio:
    version: "1.28.0"
    features: ["full"]
  serde:
    version: "1.0.160"
    features: ["derive"]
  serde_json: "1.0.96"
  tracing: "0.1.37"
  anyhow: "1.0.70"
  async-trait: "0.1.68"
  thiserror: "1.0.40"
  rand: "0.8.5"
  warp: "0.3.5"
  redis:
    version: "0.23.0"
    features: ["tokio-comp"]
  prometheus: "0.13.3"
  once_cell: "1.18.0"
  metrics: "0.21.0"
  metrics-exporter-prometheus: "0.12.1"
  num_cpus: "1.15.0"
  regex: "1.8.3"
  serde_yaml: "0.9.21"
  rules:
    - Táº¥t cáº£ cÃ¡c domain pháº£i dÃ¹ng Ä‘Ãºng version vÃ  feature nhÆ° trÃªn cho cÃ¡c dependency cá»‘t lÃµi.
    - KhÃ´ng tá»± Ã½ nÃ¢ng/háº¡ version hoáº·c thÃªm feature má»›i náº¿u chÆ°a cáº­p nháº­t cho toÃ n workspace.
    - Khi cáº§n nÃ¢ng version, pháº£i kiá»ƒm tra toÃ n bá»™ workspace vÃ  cáº­p nháº­t Ä‘á»“ng bá»™.
    - KhÃ´ng Ä‘Æ°á»£c Ã©p version cá»©ng ngoÃ i cÃ¡c version trÃªn.
    - Review code pháº£i kiá»ƒm tra dependency trÆ°á»›c khi merge.
    - CÃ³ thá»ƒ dÃ¹ng CI Ä‘á»ƒ tá»± Ä‘á»™ng kiá»ƒm tra xung Ä‘á»™t dependency.
# === END DEPENDENCY POLICY ===

# === ENHANCED PROJECT-WIDE ENFORCEMENT (Báº®T BUá»˜C TUÃ‚N THá»¦ CAO NHáº¤T) ===


mandatory_requirements:
  priority: MANDATORY
  description: >
    CÃ¡c quy táº¯c báº¯t buá»™c pháº£i tuÃ¢n thá»§ trÆ°á»›c khi sá»­a code hoáº·c phÃ¡t triá»ƒn dá»± Ã¡n
  enforcement:
    code_quality_check:
      priority: HIGHEST
      description: Báº®T BUá»˜C kiá»ƒm tra cháº¥t lÆ°á»£ng code theo tá»«ng bÆ°á»›c phÃ¡t triá»ƒn
      rules:
        - Báº¯t buá»™c khÃ´ng tá»± Ã½ sá»­a .cursorrc vÃ  BÄ‚T BUá»˜C tuÃ¢n thá»§ cÃ¡c quy táº¯c trong .cursorrc
        - Báº¯t buá»™c Sau khi táº¡o xong 1 hÃ m, check láº¡i syntax má»›i qua hÃ m káº¿ tiáº¿p
        - Báº¯t buá»™c cáº§n xÃ¡c nháº­n tá»« ngÆ°á»i dÃ¹ng trÆ°á»›c khi tá»± thÃªm file má»›i
        - Báº¯t buá»™c Sau khi táº¡o xong 1 file, quÃ©t láº¡i cÃ³ vi pháº¡m nguyÃªn táº¯c khÃ´ng, náº¿u cÃ³ thÃ¬ sá»­a láº¡i cho phÃ¹ há»£p
        - Náº¿u khÃ´ng tÃ¬m tháº¥y file cáº§n tÃ¬m, quay láº¡i quÃ©t manifest cá»§a domain hiá»‡n táº¡i
        - Báº¯t buá»™c pháº£i Ä‘á»c doc comment trÆ°á»›c khi sá»­a code
    read_manifest:
      priority: HIGHEST
      description: Báº®T BUá»˜C Ä‘á»c ká»¹ ./manifest.rs trÆ°á»›c khi sá»­a code
      rules:
        - Äá»c toÃ n bá»™ manifest.rs cá»§a domain hiá»‡n táº¡i Ä‘á»ƒ hiá»ƒu tá»• chá»©c module
        - Hiá»ƒu rÃµ thá»© tá»± Æ°u tiÃªn module: api, services, traits, utils
        - Tham kháº£o manifest.rs Ä‘á»ƒ biáº¿t tÆ°Æ¡ng tÃ¡c giá»¯a cÃ¡c domain
    scan_structure:
      priority: HIGHEST
      description: Báº®T BUá»˜C Æ°u tiÃªn quÃ©t manifest.rs cá»§a module khi quÃ©t cáº¥u trÃºc dá»¯ liá»‡u
      rules:
        - Má»—i khi yÃªu cáº§u quÃ©t cáº¥u trÃºc dá»¯ liá»‡u, LUÃ”N Ä‘á»c manifest.rs Ä‘áº§u tiÃªn
        - Khi tÃ¬m kiáº¿m file ngoÃ i luá»“ng, tham kháº£o manifest.rs sau Ä‘Ã³ quÃ©t .map Ä‘á»ƒ xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ chÃ­nh xÃ¡c
        - DÃ¹ng thÃ´ng tin trong manifest.rs Ä‘á»ƒ hiá»ƒu má»‘i quan há»‡ giá»¯a cÃ¡c file trÆ°á»›c khi tÃ¬m kiáº¿m
        - Khi Ä‘Æ°á»£c yÃªu cáº§u quÃ©t cáº¥u trÃºc vÃ  tÃ¬m lá»—i, cÃ¡c lá»—i tÃ¬m tháº¥y sáº½ Ä‘Æ°á»£c cáº­p nháº­t ná»™i dung cÃ³ kÃ¨m path file vÃ  dÃ²ng lá»—i vÃ o file .bugs
    project_entry:
      priority: HIGHEST
      description: Báº®T BUá»˜C kiá»ƒm tra vÃ  Ä‘iá»u hÆ°á»›ng dá»± Ã¡n dá»±a trÃªn manifest.rs trÆ°á»›c khi sá»­a code
      entry_points:
        - ./manifest.rs
      module_resolver:
        type: rust
        manifest_file: ./manifest.rs
        priority_order:
          - api
          - services
          - traits
          - utils
      rules:
        - Kiá»ƒm tra cáº¥u trÃºc module vÃ  dependencies dá»±a trÃªn manifest.rs
        - XÃ¡c Ä‘á»‹nh quy táº¯c vá» import order, thread safety, async patterns, error handling, type handling, caching, testing
        - KhÃ´ng vi pháº¡m báº¥t ká»³ quy táº¯c nÃ o trong .cursorrc
        - Duy trÃ¬ thá»© tá»± Æ°u tiÃªn module nhÆ° trong manifest.rs
    doc_mode:
      priority: MANDATORY
      comment: AI báº¯t buá»™c Ä‘á»c doc comment trÆ°á»›c khi phÃ¢n tÃ­ch code.
      rules:
        - KhÃ´ng sá»­a code náº¿u chÆ°a Ä‘á»c doc comment
        - Æ¯u tiÃªn sá»­a theo doc náº¿u mÃ¢u thuáº«n giá»¯a code vÃ  comment
    during_edit:
      priority: MANDATORY
      description: Báº®T BUá»˜C tuÃ¢n thá»§ khi chá»‰nh sá»­a code
      rules:
        - Duy trÃ¬ cáº¥u trÃºc module nhÆ° trong manifest.rs
        - TuÃ¢n thá»§ cÃ¡c máº«u thiáº¿t káº¿ Ä‘Ã£ thiáº¿t láº­p
        - Äá»c comment trÆ°á»›c khi sá»­a code
        - Khi táº¡o cÃ¡c folder hoáº·c file má»›i, luÃ´n dÃ¹ng cÃ¡c command cho powershell Ä‘á»ƒ táº¡o
        - Khi Ä‘Æ°á»£c yÃªu cáº§u sá»­a lá»—i, chá»‰ táº­p trung sá»­a cÃ¡c lá»—i liÃªn quan Ä‘áº¿n thÆ° má»¥c hoáº·c file Ä‘Æ°á»£c yÃªu cáº§u, khÃ´ng sá»­a lung tung ra cÃ¡c khu vá»±c khÃ¡c
        - Chá»‰ thÃ´ng bÃ¡o Ä‘áº¿n ngÆ°á»i dÃ¹ng cÃ¡c lá»—i nghiÃªm trá»ng ngoÃ i luá»“ng cáº§n sá»­a tiáº¿p theo
        - Kiá»ƒm tra cÃ¡c lá»—i chÆ°a sá»­a trong file .bugs cÃ³ liÃªn quan Ä‘áº¿n file Ä‘ang sá»­a khÃ´ng, náº¿u cÃ³ thÃ¬ sá»­a láº¡i cho phÃ¹ há»£p
        - Khi sá»­a lá»—i pháº£i Ä‘áº£m báº£o hoÃ n thiá»‡n code, xong 1 pháº¡m vi má»›i qua pháº¡m vi tiáº¿p theo
    post_check:
      priority: HIGH
      description: Báº®T BUá»˜C kiá»ƒm tra sau khi chá»‰nh sá»­a
      rules:
        - Kiá»ƒm tra tÃ­nh toÃ n váº¹n module sau khi chá»‰nh sá»­a
        - Cáº­p nháº­t tÃ i liá»‡u khi thay Ä‘á»•i chá»©c nÄƒng
        - Sau khi sá»­a lá»—i, xÃ³a Ä‘i cÃ¡c lá»—i Ä‘Ã£ Ä‘Æ°á»£c sá»­a trong file .bugs
        - Cáº­p nháº­t láº¡i cÃ¡c thay Ä‘á»•i vÃ o file manifest.rs cá»§a domain hiá»‡n táº¡i
        - Khi cáº­p nháº­t manifest.rs quÃ©t Ä‘á»‹nh dáº¡ng trÆ°á»›c vÃ   chá»‰ cáº­p nháº­t cÃ¡c thay Ä‘á»•i theo Ä‘á»‹nh dáº¡ng máº·c Ä‘á»‹nh cÃ³ sáºµn
    module_synchronization:
      priority: HIGH
      description: Báº®T BUá»˜C Ä‘áº£m báº£o Ä‘á»“ng bá»™ giá»¯a cÃ¡c module
      rules:
        - Cáº­p nháº­t tÃ i liá»‡u khi thay Ä‘á»•i module, tham kháº£o manifest.rs
        - Äáº£m báº£o trait definitions thá»‘ng nháº¥t giá»¯a cÃ¡c module
        - Cáº­p nháº­t module phá»¥ thuá»™c khi thay Ä‘á»•i interface
        - Äáº£m báº£o event handlers Ä‘Äƒng kÃ½ Ä‘áº§y Ä‘á»§
        - Äáº£m báº£o thread safety khi truy cáº­p shared state

enhanced_enforcement:
  priority: HIGHEST
  description: >
    Táº¥t cáº£ thÃ nh viÃªn vÃ  AI pháº£i tuÃ¢n thá»§ tuyá»‡t Ä‘á»‘i cÃ¡c quy táº¯c sau Ä‘á»ƒ Ä‘áº£m báº£o code Ä‘á»“ng bá»™, liÃªn káº¿t, giáº£m lá»—i thá»±c táº¿ tá»‘i Ä‘a.
  rules:
    - Má»i function, struct, trait public pháº£i cÃ³ doc comment rÃµ rÃ ng, cáº­p nháº­t khi sá»­a code.
    - Táº¥t cáº£ error pháº£i dÃ¹ng Result<T, E> vá»›i error type rÃµ rÃ ng (khÃ´ng dÃ¹ng String cho error), Æ°u tiÃªn anyhow/thiserror.
    - KhÃ´ng unwrap/expect trá»« khi test, náº¿u dÃ¹ng pháº£i log lÃ½ do rÃµ rÃ ng.
    - Táº¥t cáº£ error pháº£i cÃ³ log á»Ÿ nÆ¡i catch cuá»‘i cÃ¹ng.
    - Chá»‰ dÃ¹ng tokio::sync::Mutex/RwLock trong async context, khÃ´ng dÃ¹ng std::sync::Mutex cho async.
    - Trait object async pháº£i cÃ³ Send + Sync + 'static, kiá»ƒm tra Send/Sync khi spawn task hoáº·c truyá»n object qua thread.
    - Táº¥t cáº£ collection (HashMap, Vec, Option, Result...) pháº£i cÃ³ type annotation rÃµ rÃ ng.
    - Khi dÃ¹ng generic, luÃ´n chá»‰ Ä‘á»‹nh trait bound (T: Clone + Send + Sync + 'static náº¿u cáº§n).
    - KhÃ´ng dÃ¹ng 'static trÃ n lan, chá»‰ dÃ¹ng khi thá»±c sá»± cáº§n.
    - Import Ä‘Ãºng thá»© tá»±: external -> std -> internal -> third-party. KhÃ´ng láº·p láº¡i trait/service á»Ÿ nhiá»u nÆ¡i, chá»‰ export tá»« 1 module gá»‘c.
    - Táº¥t cáº£ mod.rs pháº£i khai bÃ¡o Ä‘á»§ module con, khÃ´ng Ä‘á»ƒ thá»«a hoáº·c thiáº¿u. KhÃ´ng Ä‘á»ƒ code thá»«a, service mock khÃ´ng cÃ²n dÃ¹ng pháº£i xoÃ¡ khá»i mod.
    - Táº¥t cáº£ struct dÃ¹ng cho config, API, validation pháº£i derive Serialize, Deserialize, Default. Struct config pháº£i cÃ³ Default vÃ  validate rÃµ rÃ ng.
    - KhÃ´ng hardcode giÃ¡ trá»‹ nháº¡y cáº£m, luÃ´n dÃ¹ng env/config.
    - Chá»‰ dÃ¹ng Ä‘Ãºng version, feature nhÆ° quy Ä‘á»‹nh trong dependency_policy. KhÃ´ng tá»± Ã½ thÃªm/xoÃ¡ dependency, má»i thay Ä‘á»•i pháº£i review toÃ n workspace.
    - Táº¥t cáº£ input pháº£i validate qua macro hoáº·c function chuáº©n hoÃ¡. KhÃ´ng dÃ¹ng regex tá»± do, pháº£i dÃ¹ng constant pattern vÃ  macro error.
    - Báº¯t buá»™c cháº¡y cargo clippy -- -D warnings, cargo test, vÃ  static analysis trÆ°á»›c khi merge. TÃ­ch há»£p CI/CD reject build náº¿u vi pháº¡m báº¥t ká»³ quy táº¯c nÃ o á»Ÿ trÃªn.
    - Review code pháº£i check Ä‘á»§: error handling, async/thread safety, type, trait, doc, import, config, security. Refactor pháº£i Ä‘á»“ng bá»™ cáº£ mod.rs, manifest, doc, test.
    - Sau má»—i láº§n sá»­a lá»—i lá»›n, cáº­p nháº­t láº¡i checklist vÃ  bá»• sung quy táº¯c má»›i vÃ o .cursorrc náº¿u cáº§n.
    - KhÃ´ng ai Ä‘Æ°á»£c phÃ©p bypass cÃ¡c quy táº¯c nÃ y, má»i vi pháº¡m pháº£i log láº¡i vÃ  sá»­a ngay.

# === TRAIT-BASED DESIGN ENFORCEMENT (Báº®T BUá»˜C ÃP Dá»¤NG) ===
trait_based_design:
  priority: HIGHEST
  description: >
    Äáº£m báº£o dá»± Ã¡n Ä‘Æ°á»£c thiáº¿t káº¿ theo hÆ°á»›ng trait-based Ä‘á»ƒ tÄƒng tÃ­nh mÃ´-Ä‘un hÃ³a, dá»… test vÃ  má»Ÿ rá»™ng.
    Thiáº¿t káº¿ nÃ y cho phÃ©p tÃ¡ch biá»‡t rÃµ rÃ ng giá»¯a cÃ¡c service cung cáº¥p vÃ  sá»­ dá»¥ng,
    dá»… dÃ ng thay tháº¿ cÃ¡c implementation, Ä‘Æ¡n giáº£n hÃ³a testing, vÃ  chuáº©n hÃ³a giao diá»‡n giá»¯a cÃ¡c module.
  rules:
    # TÃ¡ch biá»‡t rÃµ rÃ ng giá»¯a cÃ¡c service cung cáº¥p vÃ  sá»­ dá»¥ng
    - Táº¥t cáº£ cÃ¡c service/logic PHáº¢I Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a thÃ´ng qua trait trÆ°á»›c, sau Ä‘Ã³ má»›i triá»ƒn khai qua struct.
    - Táº¥t cáº£ cÃ¡c module pháº£i Ä‘á»‹nh nghÄ©a rÃµ public API thÃ´ng qua trait interface, khÃ´ng cho phÃ©p public struct implementation trá»±c tiáº¿p.
    - Äáº·t trait vÃ  implementation trong cÃ¡c file/module riÃªng biá»‡t. Trait nÃªn á»Ÿ trong module traits, impl á»Ÿ dÆ°á»›i module providers hoáº·c impls.
    - Táº¥t cáº£ cÃ¡c trait cÃ´ng khai PHáº¢I cÃ³ doc-comment mÃ´ táº£ má»¥c Ä‘Ã­ch, quy Æ°á»›c sá»­ dá»¥ng, vÃ  cÃ¡c hÃ nh vi mong Ä‘á»£i.
    - Má»—i trait method PHáº¢I cÃ³ doc-comment giáº£i thÃ­ch rÃµ input/output, panic conditions, vÃ  side effects náº¿u cÃ³.
    - TrÃ¡nh impl trait trá»±c tiáº¿p cho struct, thay vÃ o Ä‘Ã³ nÃªn táº¡o newtype pattern Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh linh hoáº¡t.
    
    # Dá»… dÃ ng thay tháº¿, má»Ÿ rá»™ng cÃ¡c implementation
    - Báº¯t buá»™c dependency injection thÃ´ng qua trait object (Arc<dyn TraitName>) cho táº¥t cáº£ cÃ¡c service.
    - Táº¥t cáº£ struct PHáº¢I nháº­n cÃ¡c dependency qua constructor chá»© khÃ´ng Ä‘Æ°á»£c tá»± táº¡o instance.
    - Má»i module pháº£i cung cáº¥p factory function Ä‘á»ƒ táº¡o instance máº·c Ä‘á»‹nh cá»§a trait (tá»©c lÃ  tiÃªu chuáº©n hÃ³a cÃ¡ch táº¡o instance).
    - Táº¥t cáº£ cÃ¡c trait PHáº¢I Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ cÃ³ thá»ƒ cÃ³ nhiá»u implementation thay tháº¿ Ä‘Æ°á»£c.
    - Táº¥t cáº£ cÃ¡c trait object PHáº¢I cÃ³ trait bound Ä‘áº§y Ä‘á»§: Send + Sync + 'static náº¿u dÃ¹ng trong async context.
    
    # ÄÆ¡n giáº£n hÃ³a viá»‡c testing báº±ng cÃ¡ch mock cÃ¡c provider
    - Má»—i module PHáº¢I cÃ³ má»™t module tests riÃªng biá»‡t chá»©a mock implementation cho cÃ¡c trait.
    - CÃ¡c mock implementation PHáº¢I Ä‘Æ¡n giáº£n vÃ  cÃ³ thá»ƒ Ä‘iá»u chá»‰nh behavior thÃ´ng qua cÃ¡c tham sá»‘ cáº¥u hÃ¬nh.
    - Má»—i trait chÃ­nh PHáº¢I cÃ³ Ã­t nháº¥t má»™t mock implementation Ä‘á»ƒ phá»¥c vá»¥ cho testing.
    - Táº¥t cáº£ cÃ¡c unit test PHáº¢I sá»­ dá»¥ng mock implementation thay vÃ¬ implementation thá»±c táº¿.
    - Táº¥t cáº£ cÃ¡c struct pháº£i Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ cÃ³ thá»ƒ mock táº¥t cáº£ cÃ¡c dependency cá»§a chÃºng.
    
    # Chuáº©n hÃ³a giao diá»‡n giá»¯a cÃ¡c module
    - Má»—i domain logic PHáº¢I cÃ´ng khai API cá»§a mÃ¬nh qua má»™t module traits hoáº·c api.
    - Táº¥t cáº£ cÃ¡c trait PHáº¢I tuÃ¢n thá»§ cÃ¹ng má»™t kiá»ƒu lá»—i (Result<T, E>) vÃ  quy Æ°á»›c Ä‘áº·t tÃªn nháº¥t quÃ¡n.
    - Táº¥t cáº£ cÃ¡c cross-module communication PHáº¢I thÃ´ng qua public trait, khÃ´ng cho phÃ©p gá»i trá»±c tiáº¿p struct method.
    - Má»—i module pháº£i cÃ³ trait rÃµ rÃ ng vá»›i methods Ä‘Æ°á»£c phÃ¢n nhÃ³m theo chá»©c nÄƒng gáº§n nhau.
    - TrÃ¡nh trait quÃ¡ lá»›n, Æ°u tiÃªn nhiá»u trait nhá» vá»›i single responsibility hÆ¡n lÃ  má»™t trait lá»›n Ä‘a chá»©c nÄƒng.
    - Sá»­ dá»¥ng composable traits: trait lá»›n hÆ¡n cÃ³ thá»ƒ yÃªu cáº§u implementation cá»§a cÃ¡c trait nhá» hÆ¡n.

  examples:
    good:
      - |
        // Trait Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a rÃµ rÃ ng, vá»›i doc comments Ä‘áº§y Ä‘á»§
        /// Trait for analyzing blockchain transactions
        #[async_trait]
        pub trait TransactionAnalyzer: Send + Sync + 'static {
            /// Analyzes a transaction and returns its risk score
            /// 
            /// # Parameters
            /// * `tx_hash` - The transaction hash to analyze
            /// * `options` - Analysis options
            /// 
            /// # Returns
            /// Risk score from 0 (safe) to 100 (very risky)
            async fn analyze_transaction(&self, tx_hash: &str, options: AnalysisOptions) -> Result<u8>;
        }
        
        // Factory function táº¡o implementation máº·c Ä‘á»‹nh
        pub fn create_transaction_analyzer(config: Config) -> Arc<dyn TransactionAnalyzer> {
            Arc::new(DefaultTransactionAnalyzer::new(config))
        }
        
        // Trong module khÃ¡c, dÃ¹ng dependency injection
        pub struct TradingBot {
            tx_analyzer: Arc<dyn TransactionAnalyzer>,
            // ...
        }
        
        impl TradingBot {
            pub fn new(tx_analyzer: Arc<dyn TransactionAnalyzer>) -> Self {
                Self { tx_analyzer, /* ... */ }
            }
        }
      - |
        // Mock implementation cho testing
        #[cfg(test)]
        mod tests {
            use super::*;
            
            struct MockTransactionAnalyzer {
                risk_score: u8,
            }
            
            #[async_trait]
            impl TransactionAnalyzer for MockTransactionAnalyzer {
                async fn analyze_transaction(&self, _tx_hash: &str, _options: AnalysisOptions) -> Result<u8> {
                    Ok(self.risk_score)
                }
            }
            
            #[tokio::test]
            async fn test_bot_with_risky_transaction() {
                let analyzer = Arc::new(MockTransactionAnalyzer { risk_score: 90 });
                let bot = TradingBot::new(analyzer);
                
                // Test risky transaction handling...
            }
        }
    bad:
      - |
        // KhÃ´ng dÃ¹ng trait, trá»±c tiáº¿p public struct implementation
        pub struct TransactionAnalyzer {
            // ...
        }
        
        impl TransactionAnalyzer {
            pub fn analyze_transaction(&self, tx_hash: &str) -> u8 {
                // CÃ³ thá»ƒ hardcode, khÃ³ thay tháº¿ implementation
                // ...
                42
            }
        }
        
        // Táº¡o instance trá»±c tiáº¿p thay vÃ¬ injection
        pub struct TradingBot {
            analyzer: TransactionAnalyzer, 
        }
        
        impl TradingBot {
            pub fn new() -> Self {
                Self { 
                    analyzer: TransactionAnalyzer::new(),
                }
            }
        }
      - |
        // Trait khÃ´ng cÃ³ doc-comment, khÃ´ng cÃ³ error handling
        pub trait Analyzer {
            fn analyze(&self, data: &str) -> u8;
        }
        
        // Implementation quÃ¡ phá»©c táº¡p vá»›i nhiá»u hard dependencies
        pub struct ComplexAnalyzer {
            db: Database,
            api_client: ApiClient,
            cache: Cache,
        }
        
        impl ComplexAnalyzer {
            pub fn new() -> Self {
                Self {
                    db: Database::connect().unwrap(), // Tá»± táº¡o dependency, unwrap lá»—i
                    api_client: ApiClient::new("hardcoded-api-key"), // Hardcoded value
                    cache: Cache::global(), // DÃ¹ng global state
                }
            }
        }
# === END TRAIT-BASED DESIGN ENFORCEMENT ===

# === END ENHANCED ENFORCEMENT ===

project:
  name: Diamondchain - SnipeBot DeFi
  description: Bot giao dá»‹ch DeFi thÃ´ng minh há»— trá»£ Ä‘a blockchain vá»›i cÃ¡c tÃ­nh nÄƒng cao cáº¥p
  version: 0.1.0
  authors:
    - Diamond Chain Team
  license: MIT
  year: 2023

rust:
  toolchain: stable-1.76.0

clippy:
  warns:
    - all
  denies:
    - unsafe_code
    - unwrap_used
    - expect_used
    - missing_docs
    - unused_must_use

format:
  enable: true
  onSave: true
  indentation: 4
  line_length: 100
  trailing_comma: true

hooks:
  pre-commit:
    - cargo fmt -- --check
    - cargo clippy -- -D warnings
    - cargo test

workspace:
  autoDiscover: true
  ignore:
    - target/
    - node_modules/
    - dist/
    - .git/
    - logs/
  modules:
    common:
      description: ThÆ° viá»‡n chung vÃ  utilities
    blockchain:
      description: TÆ°Æ¡ng tÃ¡c vá»›i blockchain, Quáº£n lÃ½ EIP-2535
    wallet:
      description: Quáº£n lÃ½ vÃ­ an toÃ n
    snipebot:
      description: Core logic cá»§a bot
    network/wasm:
      description: WebAssembly cho giao tiáº¿p máº¡ng
    diamond_manager:
      description: Quáº£n trá»‹ há»‡ thá»‘ng
    frontend:
      description: Giao diá»‡n ngÆ°á»i dÃ¹ng web
    ai_modules:
      description: CÃ¡c module AI cho phÃ¢n tÃ­ch vÃ  tá»‘i Æ°u hÃ³a giao dá»‹ch

editor:
  tab_size: 4
  ruler: 100
  formatOnSave: true
  match_extensions:
    - .rs
    - .toml
  ignored_folders:
    - target/
    - node_modules/
    - dist/
    - .git/
    - logs/

hints:
  explain_module_structure: true
  preferred_entry_comment: >
    ğŸ§­ Báº®T BUá»˜C Ä‘á»c src/registry/manifest.rs trÆ°á»›c khi sá»­a code. ÄÃ¢y lÃ  báº£n Ä‘á»“ nhá» cho tá»«ng domain, giÃºp hiá»ƒu tá»• chá»©c module vÃ  tÆ°Æ¡ng tÃ¡c trong dá»± Ã¡n.

file_discovery:
  priority: HIGH
  description: HÆ°á»›ng dáº«n tÃ¬m kiáº¿m file trong cáº¥u trÃºc dá»± Ã¡n
  rules:
    - LuÃ´n báº¯t Ä‘áº§u tá»« manifest.rs cá»§a module khi quÃ©t cáº¥u trÃºc hoáº·c tÃ¬m kiáº¿m file
    - Æ¯u tiÃªn tÃ¬m kiáº¿m file thÃ´ng qua thÃ´ng tin trong manifest.rs trÆ°á»›c khi dÃ¹ng tÃ¬m kiáº¿m tá»•ng quÃ¡t
    - Khi cáº§n xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ cá»§a má»™t module hoáº·c file cá»¥ thá»ƒ, tham kháº£o manifest.rs cá»§a domain tÆ°Æ¡ng á»©ng
  module_manifest_paths:
    wallet: wallet/manifest.rs
    snipebot: snipebot/manifest.rs
    blockchain: blockchain/manifest.rs
    network: network/manifest.rs
    common: common/manifest.rs

development_workflow:
  code_review:
    checklist:
      - Kiá»ƒm tra quy táº¯c Ä‘áº·t tÃªn
      - Kiá»ƒm tra thread safety
      - Kiá»ƒm tra error handling
      - Kiá»ƒm tra async patterns
      - Kiá»ƒm tra documentation
  testing:
    unit_tests: Viáº¿t unit test cho hÃ m quan trá»ng
    integration_tests: Viáº¿t integration test cho module
    benchmarks: ThÃªm benchmarks cho hÃ m performance-critical
  documentation:
    code_comments: Cáº­p nháº­t tÃ i liá»‡u dá»±a trÃªn cáº¥u trÃºc trong manifest.rs

file_protection:
  priority: HIGHEST
  description: >
    Cáº¤M XOÃ FILE Báº¤T Ká»² Náº¾U CHÆ¯A ÄÆ¯á»¢C NGÆ¯á»œI DÃ™NG XÃC NHáº¬N RÃ• RÃ€NG Báº°NG VÄ‚N Báº¢N.
    TRÆ¯á»šC KHI XOÃ, Báº®T BUá»˜C PHáº¢I Äá»ŒC Ká»¸ Ná»˜I DUNG FILE VÃ€ XÃC NHáº¬N Láº I Vá»šI NGÆ¯á»œI DÃ™NG.
  rules:
    - KhÃ´ng Ä‘Æ°á»£c xoÃ¡ file hoáº·c folder nÃ o náº¿u chÆ°a Ä‘Æ°á»£c ngÆ°á»i dÃ¹ng xÃ¡c nháº­n rÃµ rÃ ng.
    - TrÆ°á»›c khi xoÃ¡, pháº£i Ä‘á»c toÃ n bá»™ ná»™i dung file vÃ  log láº¡i ná»™i dung.
    - Náº¿u file chá»©a nhiá»u trait/service, chá»‰ Ä‘Æ°á»£c xoÃ¡ pháº§n liÃªn quan, khÃ´ng xoÃ¡ toÃ n bá»™ file.
    - Náº¿u lá»¡ xoÃ¡, pháº£i khÃ´i phá»¥c láº¡i ngay láº­p tá»©c hoáº·c bÃ¡o cÃ¡o cho ngÆ°á»i dÃ¹ng.
    - Khi há»£p nháº¥t vÃ  trÆ°á»›c khi xoÃ¡ file trÃ¹ng láº·p, cáº§n há»£p nháº¥t ná»™i dung trÆ°á»›c, chá»‰ Ä‘Æ°á»£c xoÃ¡ file trÃ¹ng láº·p sau khi Ä‘Ã£ há»£p nháº¥t xong.

commands:
  cargo:
    clippy: cd {directory}; cargo clippy --package {package} --lib -- -D warnings
    clippy_all: cargo clippy -- -D warnings
    build: cd {directory}; cargo build
    test: cd {directory}; cargo test
    run: cd {directory}; cargo run
    check: cd {directory}; cargo check
    fmt: cd {directory}; cargo fmt
    fix: cd {directory}; cargo fix --allow-dirty

patterns:
  naming:
    variables: snake_case
    functions: snake_case
    types: PascalCase
    constants: SCREAMING_SNAKE_CASE
    modules: snake_case
    context_flow:
      enabled: true
      comment: Dá»¯ liá»‡u vÃ  flow giá»¯a cÃ¡c module nÃªn Ä‘Æ°á»£c annotate rÃµ rÃ ng báº±ng doc-comment + macro marker.
      rules:
        - LuÃ´n thÃªm #[flow_from(...)] trÃªn cÃ¡c trait/fn nháº­n dá»¯ liá»‡u tá»« module khÃ¡c
        - Annotate luá»“ng giá»¯a cÃ¡c domain báº±ng doc comment dáº¡ng: /// Flow tá»« snipebot -> wallet -> blockchain
  imports:
    order:
      - // External imports
      - use ethers::{...};
      - ""
      - // Standard library imports
      - use std::{...};
      - ""
      - // Internal imports
      - use crate::{...};
      - ""
      - // Third party imports
      - use anyhow::{...};
      - use tracing::{...};
  error_handling:
    unwrap: TrÃ¡nh dÃ¹ng .unwrap(), .expect() trá»« khi cÃ³ lÃ½ do chÃ­nh Ä‘Ã¡ng
    result_type: Sá»­ dá»¥ng anyhow::Result vÃ  ? operator
    context: Sá»­ dá»¥ng context() hoáº·c with_context() cho lá»—i
  async:
    thread_safety:
      trait_bounds: ThÃªm Send + Sync + 'static cho trait objects trong async
      rwlock_usage: Sá»­ dá»¥ng tokio::sync::RwLock trong async context
  feature_flags:
    rules:
      - Sá»­ dá»¥ng feature flags trong Cargo.toml Ä‘á»ƒ báº­t/táº¯t tÃ­nh nÄƒng
      - Sá»­ dá»¥ng #[cfg(feature = "...")] cho conditional compilation
      - Cung cáº¥p lá»—i rÃµ rÃ ng khi tÃ­nh nÄƒng bá»‹ vÃ´ hiá»‡u hÃ³a

types:
  blockchain:
    - Address - ethers::types::Address
    - U256 - ethers::types::U256
    - H256 - ethers::types::H256
  custom:
    - ChainConfig - Cáº¥u hÃ¬nh cho blockchain
    - WalletConfig - Cáº¥u hÃ¬nh vÃ­
    - ApiResponse<T> - Cáº¥u trÃºc chung cho API Response

authentication_standardization:
  priority: HIGHEST
  description: >
    Chuáº©n hÃ³a xÃ¡c thá»±c/phÃ¢n quyá»n: CÃ¡c Ä‘á»‹nh nghÄ©a AuthService, UserRole, Claims, AuthInfo, AuthType, AuthError, Auth trait chá»‰ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a vÃ  sá»­ dá»¥ng tá»« network/security/auth_middleware.rs. KhÃ´ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a láº¡i á»Ÿ báº¥t ká»³ file nÃ o khÃ¡c. Khi cáº§n xÃ¡c thá»±c hoáº·c phÃ¢n quyá»n, luÃ´n import tá»« auth_middleware.rs.
  rules:
    - KhÃ´ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a láº¡i AuthService, UserRole, Claims, AuthInfo, AuthType, AuthError, Auth trait á»Ÿ báº¥t ká»³ file nÃ o ngoÃ i network/security/auth_middleware.rs
    - Khi cáº§n xÃ¡c thá»±c hoáº·c phÃ¢n quyá»n, luÃ´n import tá»« auth_middleware.rs
    - Náº¿u phÃ¡t hiá»‡n trÃ¹ng láº·p, pháº£i há»£p nháº¥t vá» auth_middleware.rs vÃ  xÃ³a cÃ¡c báº£n Ä‘á»‹nh nghÄ©a cÅ©

